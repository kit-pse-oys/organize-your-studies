# docker-compose: Initialisiert die einzelnen Container durch die Spezifikationen gegeben durch
# die entsprechenden DockerFiles und Umgebungsvariablen.
# docker compose --env-file .env.local up --build für lokale Entwicklung
# docker compose --env-file .env up --build für Deployment
# docker compose down --volumes --remove-orphans stoppt und entfernt alle Container, Netzwerke und Volumes (cleanup)
# Author: uhupo
services:
  db:
    image: postgres:15
    container_name: oys-postgres-db
    environment:
      - POSTGRES_DB=${DB_NAME:-oys_db}
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - TZ=Europe/Berlin
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - oys-network

  java-server:
    build: ./java-server
    container_name: oys-java-server
    ports:
      - ${SERVER_PORT}:${SERVER_PORT}   # Macht den Server unter den Port erreichbar
    environment:
      # Notwendige Umgebungsvariablen für die Java-Anwendung im Container
      - SSL_ENABLED=${SSL_ENABLED}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${DB_HOST:-db}:${DB_PORT:-5432}/${DB_NAME:-oys_db}
      - SPRING_DATASOURCE_USERNAME=${DB_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_SSL_KEY_STORE=${SERVER_SSL_KEY_STORE}
      - SERVER_SSL_KEY_STORE_PASSWORD=${SERVER_SSL_KEY_STORE_PASSWORD}
      - SERVER_SSL_KEY_STORE_TYPE=${SERVER_SSL_KEY_STORE_TYPE}
      - SERVER_PORT=${SERVER_PORT}
      - MICROSERVICE_PLANNING_URL=http://oys-python-microservice:5001/optimize
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION}
      - TZ=Europe/Berlin
    depends_on:
      - db  # Wartet, bis der Datenbank-Container gestartet ist
      - python-microservice # Wartet, bis der Python-Microservice-Container gestartet ist
    networks:
      - oys-network
    volumes:
      - /etc/letsencrypt/live/organizeyourstudies.tech/keystore.p12:/etc/letsencrypt/keystore.p12:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      # Pfad zum SSL-Keystore, nur lesbar und Mapping in den Container

  python-microservice:
    build: ./python-microservice
    container_name: oys-python-microservice
    # Keine Ports nach außen, da nur der Java-Server zugreift
    environment:
      - TZ=Europe/Berlin
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - oys-network

networks:
  oys-network:
    driver: bridge
